<section class="security-card">
  <div class="accordion-row">
    <div class="summary-copy">
      <h3>Password</h3>
      <p>Update your password regularly to keep your account secure.</p>
    </div>
    @if (!expanded()) {
      <button type="button" class="btn-outline" (click)="open()">Change Password</button>
    }
  </div>

  @if (successMessage()) {
    <div class="feedback success" role="status" aria-live="polite">{{ successMessage() }}</div>
  }

  @if (expanded()) {
  <form [formGroup]="form" (ngSubmit)="submit()" class="security-form">
    <div class="field-row">
      <label for="old_password">Old Password</label>
      <div class="password-wrap">
        <input
          id="old_password"
          [type]="showOldPassword() ? 'text' : 'password'"
          formControlName="old_password"
          autocomplete="off"
          [attr.aria-invalid]="!!getFieldError('old_password')"
        />
        <button type="button" class="toggle" (click)="toggleOldPassword()" [attr.aria-label]="'Toggle old password visibility'">
          {{ showOldPassword() ? 'Hide' : 'Show' }}
        </button>
      </div>
      @if (getFieldError('old_password') && (form.controls.old_password.touched || fieldErrors().old_password)) {
        <span class="field-error">{{ getFieldError('old_password') }}</span>
      }
    </div>

    <div class="field-row">
      <label for="new_password">New Password</label>
      <div class="password-wrap">
        <input
          id="new_password"
          [type]="showNewPassword() ? 'text' : 'password'"
          formControlName="new_password"
          autocomplete="new-password"
          [attr.aria-invalid]="!!getFieldError('new_password')"
        />
        <button type="button" class="toggle" (click)="toggleNewPassword()" [attr.aria-label]="'Toggle new password visibility'">
          {{ showNewPassword() ? 'Hide' : 'Show' }}
        </button>
      </div>
      <div class="strength">
        <div class="bar" [class]="getStrengthClass()">
          <span [style.width.%]="(strength().score / 5) * 100"></span>
        </div>
        <small>Password strength: {{ strength().label }}</small>
      </div>
      @if (getFieldError('new_password') && (form.controls.new_password.touched || fieldErrors().new_password)) {
        <span class="field-error">{{ getFieldError('new_password') }}</span>
      }
    </div>

    <div class="field-row">
      <label for="confirm_password">Confirm Password</label>
      <div class="password-wrap">
        <input
          id="confirm_password"
          [type]="showConfirmPassword() ? 'text' : 'password'"
          formControlName="confirm_password"
          autocomplete="new-password"
          [attr.aria-invalid]="!!getFieldError('confirm_password')"
        />
        <button type="button" class="toggle" (click)="toggleConfirmPassword()" [attr.aria-label]="'Toggle confirm password visibility'">
          {{ showConfirmPassword() ? 'Hide' : 'Show' }}
        </button>
      </div>
      @if (getFieldError('confirm_password') && (form.controls.confirm_password.touched || fieldErrors().confirm_password)) {
        <span class="field-error">{{ getFieldError('confirm_password') }}</span>
      }
    </div>

    @if (errorMessage()) {
      <div class="feedback error" role="alert">{{ errorMessage() }}</div>
    }

    <div class="actions">
      <button type="button" class="btn-cancel" (click)="cancel()" [disabled]="loading()">Cancel</button>
      <button type="submit" class="btn-save" [disabled]="loading()">
        @if (loading()) {
          <span class="spinner" aria-hidden="true"></span>
          <span>Updating...</span>
        } @else {
          <span>Update Password</span>
        }
      </button>
    </div>
  </form>
  }
</section>
